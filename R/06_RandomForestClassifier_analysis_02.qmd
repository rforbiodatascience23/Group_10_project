---
title: "RandomForestClassifier"
format: html
editor: visual
---

```{r}
library(tidyverse)
library(purrr)
library(randomForest)
```

## Data Preparation

```{r}
# Assuming you have a data frame called cancer_data_clean
data_folder <- '~/Desktop/'
cancer_data_clean <- read.table(paste0(data_folder,'02_dat_clean.tsv'),sep = '\t',header = TRUE)

# Display unique values in the 'diagnosis' column
cancer_data_clean <- cancer_data_clean |>
  mutate(diagnosis = ifelse(diagnosis == 1, "B", ifelse(diagnosis == 0, "M", diagnosis))) |>
  mutate(diagnosis = as.factor(diagnosis))
```

## Random Forest Classifier

```{r}
# Set seed for reproducibility
set.seed(123)

# Set up 5-fold cross-validation
n <- nrow(cancer_data_clean)
indices <- sample(n)
k <- 5
# Create folds
fold_sizes <- rep(n %/% k, k)
fold_sizes[1:(n %% k)] <- fold_sizes[1:(n %% k)] + 1
cum_fold_sizes <- cumsum(fold_sizes)
folds <- vector("list", length(fold_sizes))
start_idx <- 1
for (i in 1:length(fold_sizes)) {
  end_idx <- cum_fold_sizes[i]
  folds[[i]] <- indices[start_idx:end_idx]
  start_idx <- end_idx + 1
}

# Initialize an empty data frame to store ROC data
roc_data <- data.frame()

# Cross-validation
for (i in seq_along(folds)) {
  test_indices <- folds[[i]]
  train_indices <- setdiff(seq_len(nrow(cancer_data_clean)), test_indices)
  
  # Splitting data
  trainData <- cancer_data_clean |> slice(train_indices)
  testData <- cancer_data_clean |> slice(test_indices)
  
  # Train the model
  model <- randomForest(diagnosis ~ ., data = trainData)
  
  # Make predictions
  pred_probs <- predict(model, testData, type = "prob")
  
  # Initialize an empty data frame to store ROC data for this fold
  roc_data_fold <- data.frame()
  
  # Compute TPR and FPR for ROC
  for (threshold in seq(0, 1, by = 0.01)) {
    predicted_class <- ifelse(pred_probs[, 'M'] > threshold, 'M', 'B')
    cm <- table(Predicted = factor(predicted_class, levels = c('B', 'M')),
                Actual = factor(testData$diagnosis, levels = c('B', 'M')))
    
    tpr <- cm['M', 'M'] / sum(cm[, 'M'])
    fpr <- cm['M', 'B'] / sum(cm[, 'B'])
    
    # Append data to roc_data_fold
    roc_data_fold <- bind_rows(roc_data_fold, data.frame(FPR = fpr, TPR = tpr, Threshold = threshold, Fold = i))
  }
  
  # Append data for this fold to roc_data
  roc_data <- bind_rows(roc_data, roc_data_fold)
}
```

## Visualize the performance

```{r}
# Plot ROC curve using ggplot2
ggplot(roc_data, aes(x = FPR, y = TPR, group = as.factor(Fold), color = as.factor(Fold))) +
  geom_line(na.rm = TRUE) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  labs(title = "ROC Curve", x = "False Positive Rate", y = "True Positive Rate", color = "Fold") +
  theme_minimal()

# Display summary of roc_data
summary(roc_data)
```
